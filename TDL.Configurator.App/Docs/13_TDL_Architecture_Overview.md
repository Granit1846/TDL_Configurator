# TDL: архитектура мода

## Основные компоненты

### `TDL_MainController`
Центральный диспетчер стадий:
- единая точка, которая **вызывает `SetStage`**;
- отвечает за переходы и “режимы” (stages).

### `TDL_StreamController`
Арбитр входящих событий:
- принимает `ActionID` и `SourceType`;
- применяет **приоритеты**, **кулдауны**, **очередь**;
- решает: запускать сейчас, отложить, отклонить.

### MCM Stream Page
Локальный эмулятор стрима:
- предназначен для тестов без внешних инструментов;
- использует **тот же путь выполнения**, что и стрим (через `StreamController`).

## Модули стадий
Каждая группа (например `Chaos`, `Comedy`, `Wrath`, `Inventory`, `Hunter` и т.д.) реализована отдельным **Quest‑скриптом**:
- модули **не знают друг о друге**;
- каждый модуль отвечает только за свою логику и эффекты.

## Принципы проектирования
- **Papyrus не предназначен для сети и IPC через файлы.**  
  Файлы/JSON — это хранилище, но не “вход событий”.
- Любой внешний API подключается через **SKSE‑слой**.
- “Бизнес‑логика” должна жить **внутри игры**, а не во внешнем коде.
- MCM и стрим используют **единый путь** — так тесты в MCM воспроизводят поведение стрима.

## Поток выполнения (упрощённо)
1) Источник (стрим/локальный UI) формирует `ActionID`.
2) Запрос попадает в `TDL_StreamController`.
3) Контроллер применяет правила (priority/cooldown/queue).
4) Разрешённый запрос переводится в стадию/модуль и выполняется в игре.

## Статус
Papyrus‑часть TDL рассматривается как стабильная база; расширения внешнего ввода реализуются через SKSE‑слой.
